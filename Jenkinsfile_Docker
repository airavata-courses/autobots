def purgeImages() {
   try {
      sh 'docker stop $(docker ps -aq)'
	  sh 'docker rm $(docker ps -aq)'
	  sh 'docker rmi $(docker images -q)'
   }
   catch(error) {
   
   }
}

node{
    stage('Permissions') {
          sh 'usermod -aG docker ${USER}'
	   sh 'chown $USER:$USER -R .'
	}
    stage('Pull') {
        checkout scm
        sh 'docker-compose -f docker-compose.yml up -d'
	}
    stage('Test') {
        sh 'docker-compose exec broker kafka-topics --create --zookeeper zookeeper:2181 --replication-factor 1 --partitions 1 --topic trump'	
	}
	stage('Prune') {
	   purgeImages()
	}
  }
